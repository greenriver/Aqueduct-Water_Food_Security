@host = https://api.resourcewatch.org
@token = Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYzYzcwOTBiZTU5MTU5NmYyN2MxOThjYSIsInJvbGUiOiJBRE1JTiIsInByb3ZpZGVyIjoibG9jYWwiLCJlbWFpbCI6IkNhcmxvcy5EZWxSZWFsLjVAd3JpY29uc3VsdGFudC5vcmciLCJleHRyYVVzZXJEYXRhIjp7ImFwcHMiOlsicnciLCJhcXVlZHVjdCIsImFxdWVkdWN0LXdhdGVyLXJpc2siXX0sImNyZWF0ZWRBdCI6MTY4Njc3NTUyNTAyNSwicGhvdG8iOiJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vd3JpLWFwaS1iYWNrdXBzL3Jlc291cmNld2F0Y2gvc3RhZ2luZy9wcm9maWxlcy9hdmF0YXJzLzAwMC8wMDAvMjU4L29yaWdpbmFsL2RhdGE_MTY3NDA2ODA0NyIsIm5hbWUiOiJDYXJsb3MgRGVsIFJlYWwiLCJpYXQiOjE2ODY3NzU1MjV9.3J7HR6Et_5wmJbbfjnh_7ZvrClzIsRAdwaqMJEMmOuM


### get old layer
GET {{host}}/v1/layer/6f339b41-ea2f-4502-a454-d03bb22b540b
### create layer in new dataset

### get new dataset with layers
GET {{host}}/v1/dataset/1ab7ce3e-a8b4-45d4-b136-7f6015662a09?includes=layer
### create layer in new dataset

POST {{host}}/v1/dataset/1ab7ce3e-a8b4-45d4-b136-7f6015662a09/layer
Content-Type: application/json
Authorization: {{token}}

{
    "name": "Projected Water Stress",
    "application": [
        "aqueduct"
    ],
    "provider": "cartodb",
    "env": "production",
    "layerConfig": {
        "account": "wri-rw",
        "params_config": [],
        "sql_config": [
            {
                "key": "and",
                "key_params": [
                    {
                        "key": "year",
                        "required": true
                    },
                    {
                        "key": "scenario",
                        "required": true
                    }
                ]
            },
            {
                "key": "where",
                "key_params": [
                    {
                        "key": "iso",
                        "required": false
                    },
                    {
                        "key": "crop",
                        "required": false
                    },
                    {
                        "key": "irrigation",
                        "required": false
                    },
                    {
                        "key": "rank",
                        "required": false
                    }
                ]
            }
        ],
        "body": {
            "maxzoom": 18,
            "minzoom": 3,
            "layers": [
                {
                    "type": "cartodb",
                    "options": {
                        "sql": "with r as (SELECT basinid, label FROM water_risk_indicators_future_aqueduct40 WHERE type = 'future_value' and indicator = 'water_stress' {{and}} ) SELECT s.cartodb_id, s.pfaf_id, s.the_geom, s.the_geom_webmercator, r.label FROM y2018m12d06_rh_master_shape_v01 s LEFT JOIN r on s.pfaf_id=r.pfaf_id WHERE s.the_geom is not null and r.label is not null",
                        "cartocss": "#water_risk_indicators_projections{ polygon-fill:transparent; polygon-opacity: 1; line-color:transparent; line-width: 1; line-opacity: 1; } #water_risk_indicators_projections [label='Extremely high (>80%)'] { polygon-fill:#990000; line-color:#990000 } #water_risk_indicators_projections [label='High (40-80%)'] { polygon-fill:  #FF1900; line-color:  #FF1900 } #water_risk_indicators_projections [label='Medium-high (20-40%)'] { polygon-fill: #FF9900; line-color: #FF9900 } #water_risk_indicators_projections [label='Low-medium (10-20%)'] { polygon-fill: #FFE600; line-color:  #FFE600 } #water_risk_indicators_projections [label='Low (<10%)'] { polygon-fill: #FFFF99; line-color:  #FFFF99 } #water_risk_indicators_projections [label='Arid and low water use'] { polygon-fill:#808080; line-color:  #808080 } #water_risk_indicators_projections [label='No data'] { polygon-fill: #4E4E4E; line-color:  #4E4E4E }",
                        "cartocss_version": "2.3.0"
                    }
                },
                {
                    "type": "cartodb",
                    "options": {
                        "sql": "SELECT cartodb_id, the_geom_webmercator FROM crops_projected {{where}}",
                        "cartocss": "  #layer{polygon-fill: #FF6600; polygon-opacity: 1; line-color: #FF6600; line-width: 0.5; line-opacity: 1; comp-op: dst-in;}",
                        "cartocss_version": "2.3.0"
                    }
                }
            ]
        }
    },
    "legendConfig": {
        "type": "choropleth",
        "items": [
            {
                "name": "Low",
                "value": "(<10%)",
                "color": "#FFFF99"
            },
            {
                "name": "Low-medium",
                "value": "(10-20%)",
                "color": "#FFE600"
            },
            {
                "name": "Medium-high",
                "value": "(20-40%)",
                "color": "#FF9900"
            },
            {
                "name": "High",
                "value": "(40-80%)",
                "color": "#FF1900"
            },
            {
                "name": "Extremely high",
                "value": "(>80%)",
                "color": "#990000"
            }
        ],
        "disclaimer": [
            {
                "name": "Arid and low water use",
                "color": "#808080"
            },
            {
                "name": "No data",
                "color": "#4E4E4E"
            }
        ]
    }
}